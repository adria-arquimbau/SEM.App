@using SEM.App.Data
@using SEM.App.Components.Loadings
@using SEM.App.Authentication

@inject EventsService EventsService
@inject AuthenticationStateProvider authenticationStateProvider
@inject NavigationManager Navigation
@inject HttpClient HttpClient

<div class="eventRegistrations">
    <h4>Registrations</h4>
    
    <div class="eventRegistrations-state">
        <h5>My registration state</h5>
        <AuthorizeView>
            <Authorized>
                @if (RegistrationState.HasValue)
                {
                    <div class="event-field">
                        <b>Registration state: </b>
                        @if (RegistrationState is Data.RegistrationState.Accepted) @AcceptedState
                        @if (RegistrationState is Data.RegistrationState.PreRegistered) @PreRegisteredState
                        @if (RegistrationState is Data.RegistrationState.NonRegistered) @NonRegisteredState
                        @if (RegistrationState is Data.RegistrationState.Cancelled) @CancelledState
                    </div>
                    <div class="event-field">
                        @if (RegistrationState == Data.RegistrationState.PreRegistered)
                        {
                            <div class="alert alert-warning" role="alert">
                                You're pre-registered. Now an organizer have to confirm your registration.
                            </div>
                        }
                        @if (RegistrationState == Data.RegistrationState.Cancelled)
                        {
                            <div class="alert alert-danger" role="alert">
                                You're registration was cancelled. Talk with the organizer.
                            </div>
                        }
                    </div>
                    @if (FailedRegistration)
                    {
                        <div class="alert alert-warning" role="alert">
                            @FailedRegistrationMessage @TwoEmptySpaces
                            @if (FailedRegistrationMessage!.Contains("not the minimum information"))
                            {
                                @if (!RequestingGoToMyAccount)
                                {
                                    <button type="button" class="btn btn-outline-dark btn-sm" @onclick="GoToMyAccount">Set information in my account</button>
                                }
                                else
                                {
                                    <LoadingButton ButtonType="primary" LoadingText="Going to my account"></LoadingButton>
                                }
                            }
                        </div>
                    }
                    <div class="event-field">

                        @if (RegistrationState == Data.RegistrationState.NonRegistered && SportEvent?.OpenRegistrationsDateTime < DateTime.Now && SportEvent.CloseRegistrationsDateTime > DateTime.Now)
                        {
                            @if (!RequestingSignUp)
                            {
                                <button type="button" class="btn btn-outline-dark btn-sm" @onclick="SignUp">Sign up</button>
                            }
                            else
                            {
                                <LoadingButton ButtonType="dark" LoadingText="Signing up"></LoadingButton>
                            }
                        }

                    </div>
                }
                else
                {
                    <SimpleLoading></SimpleLoading>
                }
            </Authorized>
            <NotAuthorized>
                <div class="alert alert-warning" role="alert">
                    You must login to register for this event.
                </div>
            </NotAuthorized>
        </AuthorizeView>
    </div>
    <div class="eventRegistrations-registrations">
        <h5>Registrations list</h5>
        <AuthorizeView>
            <Authorized>
                @if (Registrations != null)
                {
                    <table class="table table-striped">
                        <thead>
                        <th scope="col">Num</th>
                        <th scope="col">User Name</th>
                        <th scope="col">Role</th>
                        <th scope="col">Bib</th>
                        </thead>
                        @for (var index = 0; index < Registrations?.Count; index++)
                        {
                            var registration = Registrations[index];
                            var registrationNumber = index + 1;
                            <tbody>
                            <tr>
                                <td>@registrationNumber</td>
                                <td>@registration.UserName</td>
                                <td>@registration.Role</td>
                                <td>@registration.Bib</td>
                            </tr>
                            </tbody>
                        }
                    </table>
                }
                else
                {
                    <SimpleLoading></SimpleLoading>
                }
            </Authorized>
            <NotAuthorized>
                <table class="table table-striped">
                    <thead>
                    <th scope="col">Num</th>
                    <th scope="col">User Name</th>
                    <th scope="col">Role</th>
                    <th scope="col">Bib</th>
                    </thead>
                </table>
                <div class="alert alert-warning" role="alert">
                    You must Log in to see the registrations of this event.
                </div>
            </NotAuthorized>
        </AuthorizeView>
    </div>
    
</div>


@code {
    [Parameter]
    public SportEvent? SportEvent { get; set; }
    private List<RegistrationDto>? Registrations { get; set; }
    
    private RegistrationState? RegistrationState;
        
    private bool RequestingSignUp { get; set; }
    private bool FailedRegistration { get; set; }
    private bool RequestingGoToMyAccount { get; set; }  
    private bool RequestingRegistrations { get; set; }
    private bool RequestingRegistrationState { get; set; }
    
    private string? FailedRegistrationMessage;
    private const string TwoEmptySpaces = " ";
    
    private const string semApiUrl = "https://sport-management-api.azurewebsites.net/api/";
    private string Token = string.Empty;
    
    private const string AcceptedState = "‚úÖ Accepted";
    private const string NonRegisteredState = "‚ùå Non registered";
    private const string PreRegisteredState = "üîî Pre-registered";
    private const string CancelledState = "‚õî Cancelled";

    protected override async Task OnInitializedAsync()
    {
        var customAuthStateProvider = (CustomAuthenticationStateProvider)authenticationStateProvider;
        Token = await customAuthStateProvider.GetToken();
        if (!string.IsNullOrWhiteSpace(Token))
        {
            await GetRegisteredState();
            await GetRegistrations();
        }
        await base.OnInitializedAsync();
    }

    private async Task SignUp()
    {
        RequestingSignUp = true;

        var response = await EventsService.RegisterToAnEvent(Token, SportEvent.Id);
        if (response.SuccessRegistration)
        {
            SportEvent = await EventsService.GetEvent(SportEvent.Id);
            await GetRegisteredState();
            await GetRegistrations();
            RequestingSignUp = false;
        }
        if (!response.SuccessRegistration)
        {
            FailedRegistration = true;
            FailedRegistrationMessage = response.Message;
            RequestingSignUp = false;
        }
    }
    
    private async Task GetRegisteredState()
    {
        RequestingRegistrationState = true;
        var iAmRegisteredResponse = await EventsService.IAmRegistered(SportEvent.Id, Token);
        RegistrationState = iAmRegisteredResponse.RegistrationState;
        RequestingRegistrationState = false;
    }
    
    private async Task GetRegistrations()
    {
        RequestingRegistrations = true;
        var registrations = await EventsService.GetAcceptedRegistrationsByEventId(SportEvent.Id, Token);
        Registrations = registrations;
        RequestingRegistrations = false;
    }
    
    private void GoToMyAccount()
    {
        RequestingGoToMyAccount = true;
        Navigation.NavigateTo($"/account");
        RequestingGoToMyAccount = false;
    }
}