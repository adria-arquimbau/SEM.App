@page "/admin-panel"
@attribute [Authorize(Roles = "SEM3:SPORT_EVENTS_MANAGEMENT_ADMIN")]

@using SEM.App.Data
@using SEM.App.Authentication

@inject UsersService UsersService
@inject AuthenticationStateProvider authenticationStateProvider

<PageTitle>Admin Panel</PageTitle>

<div class="admin-panel-page">
    <h1>Admin Panel</h1> 

    @if (users == null)
    {
        <div class="spinner-border" role="status"></div>
        <p>Loading active users in the application... Please wait</p>
    } 
    else
    {
        <h2>Users</h2>
        @foreach (var user in users)
        {
            <div class="user-container">
                <p>User Name: @user.UserName</p>
                <p>Name: @user.Name</p>
                <p>Email: @user.Email</p>
                <p>Confirmed email: @user.EmailConfirmed</p>
                <p>Registration date: @user.RegistrationDate</p>
                <p>Last login time: @user.LastLoginTime</p>
                
                @if (!user.EmailConfirmed)
                {
                    <button class="btn btn-info" @onclick="() => ConfirmEmail(user.Id)">Confirm Email</button>
                }
            </div>
        }
    }
</div>


@code
{
    private List<UserDto>? users;

    protected override async Task OnInitializedAsync()
    {
        await GetUsers();
        await base.OnInitializedAsync();
    }

    private async Task ConfirmEmail(Guid userId)
    {
        var customAuthStateProvider = (CustomAuthenticationStateProvider)authenticationStateProvider;
        var token = await customAuthStateProvider.GetToken();
        await UsersService.ConfirmEmail(token, userId);
        await GetUsers();
    }
    
    private async Task GetUsers()
    {   
        var customAuthStateProvider = (CustomAuthenticationStateProvider)authenticationStateProvider;
        var token = await customAuthStateProvider.GetToken();
        users = await UsersService.GetUsers(token);
    }
}
